steps:
  # 1Ô∏è‚É£ .env „Çí JSON „Å´Â§âÊèõ„Åó„Å¶ Secret Manager Êõ¥Êñ∞
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'update-secrets'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üîç Secret Manager Êõ¥Êñ∞ÈñãÂßã..."
        if [ ! -f .env ]; then
          echo ".env „Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"
          exit 1
        fi

        # JSON „Å´Â§âÊèõ
        jq -Rn '
          (input | split("\n"))
          | map(select(length > 0))
          | map(split("="))
          | map({(.[0]): .[1]})
          | add
        ' < .env > env.json

        # Secret Manager Êõ¥Êñ∞„É´„Éº„Éó
        for key in $(jq -r 'keys[]' env.json); do
          value=$(jq -r --arg k "$key" '.[$k]' env.json)
          if ! gcloud secrets describe "$key" >/dev/null 2>&1; then
            gcloud secrets create "$key" --replication-policy="automatic"
          fi
          current_value=$(gcloud secrets versions access latest --secret="$key" || echo "")
          if [ "$current_value" != "$value" ]; then
            echo -n "$value" | gcloud secrets versions add "$key" --data-file=-
          fi
        done

  # 2Ô∏è‚É£ Docker „Éì„É´„Éâ & push
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/cloudrun-sample-api', '.']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/cloudrun-sample-api']

  # 3Ô∏è‚É£ Cloud Run „Éá„Éó„É≠„Ç§
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-cloud-run'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        DEPLOY_ARGS=""
        for key in $(jq -r 'keys[]' env.json); do
          DEPLOY_ARGS="$DEPLOY_ARGS --update-secrets ${key}=${key}:latest"
        done

        gcloud run deploy cloudrun-sample-api \
          --image gcr.io/$PROJECT_ID/cloudrun-sample-api \
          --region asia-northeast1 \
          --allow-unauthenticated \
          $DEPLOY_ARGS
